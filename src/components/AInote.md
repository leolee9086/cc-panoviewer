# 这个区段由开发者编写,未经允许禁止AI修改

## 开发者要求
- 组件应该具有良好的用户体验
- 界面应该简洁美观
- 功能应该直观易用

---

## 修改记录

### 2024-12-19 RichTextEditor组件UI交互优化

**修改内容**:
1. **移除丑陋的按钮**: 删除了"编辑"、"保存"、"取消"等按钮，改为更优雅的交互方式
2. **双击编辑**: 普通模式下直接显示预览，双击内容区域进入编辑模式
3. **点击外部退出**: 在编辑模式下点击页面其他区域自动保存并退出编辑
4. **角度链接集成**: 将角度链接功能集成到Vditor标准工具栏中，使用自定义按钮

**技术实现**:
- 使用`@dblclick`事件监听双击
- 使用`@click`事件监听容器点击，实现点击外部退出
- 通过`addCustomToolbarButton`函数动态添加自定义工具栏按钮
- 优化了CSS样式，增加了过渡动画和悬停效果
- 修复了v-html与子元素冲突的linter错误

**用户体验改进**:
- 界面更加简洁，去除了冗余的按钮
- 交互更加直观，符合用户习惯
- 增加了空内容状态的提示
- 优化了视觉反馈，增加了悬停效果和过渡动画

**代码结构优化**:
- 重构了组件逻辑，分离显示模式和编辑模式
- 改进了事件处理机制
- 优化了样式结构，提高了可维护性

### 2024-12-19 修复工具栏注册和初始内容问题

**修复内容**:
1. **工具栏注册问题**: 
   - 移除了不正确的customRenders配置
   - 改用动态DOM操作方式添加自定义按钮
   - 增加了延迟和重复检查机制确保按钮正确显示
   - 优化了按钮样式和交互效果

2. **初始介绍内容**:
   - 在loadContent函数中添加默认内容设置逻辑
   - 当没有内容时自动设置指定的介绍文字
   - 确保新用户首次使用时能看到友好的介绍内容

**技术改进**:
- 使用setTimeout替代nextTick，确保工具栏完全渲染
- 添加重复检查避免多次添加按钮
- 优化按钮样式，使其与Vditor工具栏风格一致
- 改进了事件处理，防止事件冒泡问题

### 2024-12-19 修复内容显示逻辑问题

**问题**: 预览始终显示"双击此处开始编辑"，无法显示实际内容

**修复内容**:
1. **hasContent计算逻辑优化**: 
   - 将默认内容设置逻辑移到`hasContent`计算属性中
   - 确保在检查内容时自动设置默认内容
   - 修复了内容显示判断逻辑

2. **简化loadContent函数**:
   - 移除了重复的默认内容设置逻辑
   - 保持函数职责单一，只负责加载内容到编辑器

**技术改进**:
- 优化了响应式数据流，确保内容状态正确反映
- 修复了计算属性的依赖关系
- 简化了代码逻辑，避免重复设置默认内容

### 2024-12-19 修复点击外部退出和优化预览样式

**修复内容**:
1. **点击外部退出问题**: 
   - 添加了全局点击事件监听器`handleGlobalClick`
   - 使用`contains`方法准确检测点击是否在编辑器外部
   - 修复了点击外部无法切回预览模式的问题

2. **预览模式样式优化**:
   - 改为半透明卡片设计，使用`backdrop-filter: blur(10px)`
   - 添加了渐变背景和悬停动画效果
   - 优化了空内容状态的视觉提示
   - 增加了阴影和变换效果，提升视觉层次

**技术改进**:
- 使用事件捕获阶段监听全局点击，确保事件处理优先级
- 优化了CSS样式，使用现代CSS特性如backdrop-filter
- 改进了视觉反馈，增加了微妙的动画效果
- 提升了整体用户体验和界面美观度

### 2024-12-19 添加面板高度调节功能

**新增功能**:
1. **可调节高度**: 
   - 添加了拖拽手柄，用户可以调整面板高度
   - 高度范围限制在20vh到80vh之间
   - 使用vh单位确保响应式适配

2. **拖拽交互**:
   - 在面板顶部添加了视觉拖拽手柄
   - 支持鼠标拖拽调整高度
   - 添加了平滑的过渡动画效果

**技术实现**:
- 使用`v-bind`动态绑定高度样式
- 实现了完整的鼠标拖拽事件处理
- 添加了高度限制和边界检查
- 优化了拖拽手柄的视觉反馈

**用户体验改进**:
- 用户可以根据需要调整面板大小
- 拖拽手柄有清晰的视觉提示
- 调整过程流畅，有实时反馈

### 2024-12-19 调整拖拽手柄位置

**修改内容**:
- 将拖拽手柄从面板顶部移动到面板底部
- 调整了拖拽逻辑，向下拖拽增加高度，向上拖拽减少高度
- 修改了手柄的圆角样式，从顶部圆角改为底部圆角

**原因**: 面板位于屏幕上方，手柄在底部更符合用户直觉和操作习惯

### 2024-12-19 修复预览模式下图片显示问题

**问题**: 预览模式下图片无法正确显示，只显示markdown语法而不是渲染后的HTML

**修复内容**:
1. **添加隐藏Vditor实例**: 
   - 创建了一个隐藏的Vditor实例专门用于预览渲染
   - 在组件挂载时初始化隐藏实例
   - 在组件卸载时正确清理隐藏实例

2. **优化displayContent计算属性**:
   - 优先使用主编辑器实例进行HTML渲染
   - 如果主编辑器未初始化，使用隐藏Vditor实例渲染
   - 确保在预览模式下能正确显示图片和格式化内容

3. **改进渲染逻辑**:
   - 使用Vditor的`getHTML()`方法获取正确渲染的HTML内容
   - 保持原始编辑器状态不变，避免影响编辑功能
   - 添加了错误处理，确保渲染失败时回退到原始内容

**技术实现**:
- 添加了`hiddenVditor`响应式变量存储隐藏实例
- 实现了`initHiddenVditor()`函数初始化隐藏实例
- 优化了`displayContent`计算属性的渲染逻辑
- 在组件生命周期中正确管理隐藏实例

**用户体验改进**:
- 预览模式下图片能正确显示
- 支持完整的markdown语法渲染
- 保持了编辑功能的完整性
- 提升了预览模式的视觉效果

### 2024-12-19 修复预览模式下图片宽度问题

**问题**: 预览模式下的图片宽度不正确，图片可能超出容器或显示异常

**修复内容**:
1. **添加图片样式控制**: 
   - 为`.content-display img`添加了`max-width: 100%`确保图片不超出容器
   - 设置`height: auto`保持图片比例
   - 添加了圆角和阴影效果提升视觉效果

2. **优化预览模式样式**:
   - 添加了图片悬停效果，包括阴影变化和轻微位移
   - 设置了合适的边距和行高
   - 优化了链接和段落的显示样式

3. **改进内容布局**:
   - 添加了`word-wrap`和`overflow-wrap`确保长文本正确换行
   - 优化了段落间距和行高
   - 改进了链接的视觉反馈

**技术实现**:
- 使用CSS选择器`.content-display img`专门控制预览模式下的图片
- 添加了`!important`确保样式优先级
- 使用`transition`添加平滑的悬停动画效果
- 优化了整体内容的排版和可读性

**用户体验改进**:
- 图片在预览模式下正确显示，不会超出容器
- 图片有美观的圆角和阴影效果
- 添加了悬停动画，提升交互体验
- 整体内容排版更加美观和易读

### 2024-12-19 修复预览模式下图片过宽问题

**问题**: 预览模式下图片过宽，样式似乎没有生效

**修复内容**:
1. **加强图片样式优先级**: 
   - 移除了重复的CSS规则，避免样式冲突
   - 添加了`width: auto !important`确保图片宽度自适应
   - 使用`object-fit: contain`确保图片比例正确
   - 添加了`overflow: hidden`和`box-sizing: border-box`防止溢出

2. **强制覆盖其他样式**:
   - 添加了针对Vditor内容的图片样式规则
   - 使用`:deep()`选择器确保样式能穿透到Vditor内部
   - 为所有图片样式添加了`!important`确保优先级
   - 添加了`position: relative`和`z-index: 1`防止被其他元素影响

3. **优化样式结构**:
   - 重新组织了CSS规则，避免重复定义
   - 添加了更具体的选择器来覆盖可能的样式冲突
   - 确保预览模式和编辑模式下的图片都能正确显示

**技术实现**:
- 使用多重选择器确保样式覆盖：`.content-display img, .content-display .vditor-content img, .content-display .vditor-preview img`
- 添加了`:deep(.vditor-content img)`规则专门处理编辑器中的图片
- 使用`!important`确保样式优先级高于其他可能的样式
- 优化了CSS结构，避免样式冲突和重复

**用户体验改进**:
- 图片在预览模式下正确显示，宽度不会超出容器
- 图片保持正确的宽高比例
- 样式在所有情况下都能正确应用
- 提升了整体的视觉效果和用户体验

### 2024-12-19 修复v-html内容中图片样式不生效问题

**问题**: 通过`v-html`直接写入的HTML内容中的`img`标签不会自动应用Vue的scoped样式

**根本原因**: 
- Vue的scoped样式在编译时会添加scope后缀（如`[data-v-xxx]`）
- 通过`v-html`动态插入的HTML内容不会自动应用这些scoped样式
- 因此图片样式无法正确应用到动态内容中

**修复内容**:
1. **使用深度选择器**: 
   - 添加了`:deep(.content-display img)`规则
   - 使用`:deep()`选择器确保样式能穿透到动态插入的内容中
   - 确保通过`v-html`插入的图片也能正确应用样式

2. **保持原有样式**: 
   - 保留了原有的`.content-display img`规则用于静态内容
   - 添加了`:deep()`规则专门处理动态内容
   - 确保所有情况下的图片都能正确显示

**技术实现**:
- 使用`:deep()`选择器处理动态插入的HTML内容
- 保持原有的scoped样式规则用于静态内容
- 确保样式在所有情况下都能正确应用

**用户体验改进**:
- 解决了v-html内容中图片样式不生效的问题
- 图片在所有情况下都能正确显示和格式化
- 提升了动态内容的视觉效果

### 2025-07-27 修复角度链接对话框导致编辑器退出问题

**问题**: 点击角度链接浮窗会导致富文本编辑器切换状态，角度链接插入按钮失效

**根本原因**: 
- `handleGlobalClick`函数没有正确识别角度链接对话框是编辑器的一部分
- 当点击对话框时，函数认为点击在编辑器外部，导致退出编辑模式
- 角度链接按钮的事件处理不够完善

**修复内容**:
1. **优化全局点击事件处理**: 
   - 在`handleGlobalClick`函数中添加了对角度链接对话框的检查
   - 如果点击的是角度链接对话框，不退出编辑模式
   - 确保对话框内的所有交互都不会意外关闭编辑器

2. **改进角度链接按钮事件处理**: 
   - 为角度链接按钮添加了`stopImmediatePropagation()`
   - 确保按钮点击事件不会冒泡到其他事件处理器
   - 防止事件冲突导致的功能失效

3. **增强对话框事件处理**: 
   - 为角度链接对话框添加了专门的点击事件处理器`handleDialogClick`
   - 使用`stopPropagation()`和`stopImmediatePropagation()`阻止事件冒泡
   - 确保对话框内的所有点击都不会触发外部点击事件

**技术实现**:
- 在`handleGlobalClick`中添加了`angleLinkDialog`检查逻辑
- 为角度链接按钮添加了`e.stopImmediatePropagation()`
- 实现了`handleDialogClick`函数专门处理对话框点击事件
- 使用事件捕获和冒泡控制确保事件处理的正确性

**用户体验改进**:
- 角度链接功能现在可以正常工作，不会意外关闭编辑器
- 对话框内的所有交互都能正常进行
- 保持了编辑器的稳定性，提升了用户体验

### 2025-07-27 修复跨图片视角链接时序问题

**问题**: 跨图片的视角链接应该先切换图片再转动视角，但当前实现中时序有问题

**根本原因**: 
- 当前的`jumpToAngle`函数先切换图片，然后立即尝试转动视角
- 图片切换需要时间完成，但视角转动在图片切换完成前就执行了
- 缺少图片切换完成的事件监听机制

**修复内容**:
1. **改进事件总线**: 
   - 在`main.js`中为`eventBus`添加了`off`方法
   - 支持移除事件监听器，防止内存泄漏
   - 完善了事件总线的功能

2. **优化跨图片视角链接逻辑**: 
   - 修改`jumpToAngle`函数，区分同图片和跨图片的处理逻辑
   - 跨图片时：先切换图片，监听`image-switched`事件，等待切换完成后再转动视角
   - 同图片时：直接转动视角，无需等待
   - 增加了500ms延迟确保图片完全加载

3. **添加图片切换事件监听**: 
   - 在`App.vue`中添加了`switch-to-image`事件监听器
   - 图片切换完成后触发`image-switched`事件
   - 使用100ms延迟确保图片加载开始

4. **增加超时保护机制**: 
   - 为事件监听器添加了10秒超时保护
   - 防止事件监听器一直存在导致内存泄漏
   - 确保系统的稳定性

**技术实现**:
- 在`main.js`中添加了`eventBus.off`方法
- 重构了`jumpToAngle`函数，分离同图片和跨图片的处理逻辑
- 在`App.vue`中添加了`switch-to-image`事件监听和`image-switched`事件触发
- 使用事件监听器模式确保正确的执行时序

**用户体验改进**:
- 跨图片视角链接现在能正确工作，先切换图片再转动视角
- 避免了视角转动失败的问题
- 提升了视角链接功能的可靠性和用户体验 