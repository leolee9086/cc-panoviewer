<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentDB 测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }
        .status.success {
            background-color: #28a745;
        }
        .status.error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DocumentDB 测试页面</h1>
        <p>这个页面用于测试 DocumentDB 模块的各种功能。</p>

        <div class="test-section">
            <h3>基本功能测试</h3>
            <button onclick="testBasicFunctions()">测试基本功能</button>
            <div id="basic-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>事务功能测试</h3>
            <button onclick="testTransactionFunctions()">测试事务功能</button>
            <div id="transaction-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>导出功能测试</h3>
            <button onclick="testExportFunctions()">测试导出功能</button>
            <div id="export-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>性能测试</h3>
            <button onclick="testPerformance()">测试性能</button>
            <div id="performance-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>完整测试套件</h3>
            <button onclick="runAllTests()">运行所有测试</button>
            <div id="all-tests-result" class="result"></div>
        </div>
    </div>

    <div id="status" class="status" style="display: none;"></div>

    <script type="module">
        import { DocumentDB } from '../src/scripts/document-db.js';
        
        // 将DocumentDB暴露到全局作用域，供测试使用
        window.DocumentDB = DocumentDB;
        
        // 测试结果记录
        window.testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };

        // 显示状态
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // 显示结果
        function showResult(elementId, content, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `result ${type}`;
        }

        // 基本功能测试
        window.testBasicFunctions = function() {
            try {
                const db = new DocumentDB(document);
                
                // 测试设置和获取
                db.set('test1', 'value1');
                db.set('test2', { data: 'value2' });
                db.set('test3', 123);
                db.set('test4', true);
                db.set('test5', null);
                
                const value1 = db.get('test1');
                const value2 = db.get('test2');
                const value3 = db.get('test3');
                const value4 = db.get('test4');
                const value5 = db.get('test5');
                
                // 测试检查存在
                const hasTest1 = db.has('test1');
                const hasTest6 = db.has('test6');
                
                // 测试列出所有键
                const keys = db.list();
                
                const result = `
                    <h4>基本功能测试结果：</h4>
                    <p><strong>设置和获取：</strong></p>
                    <ul>
                        <li>test1: ${value1} ${value1 === 'value1' ? '✅' : '❌'}</li>
                        <li>test2: ${JSON.stringify(value2)} ${JSON.stringify(value2) === '{"data":"value2"}' ? '✅' : '❌'}</li>
                        <li>test3: ${value3} ${value3 === 123 ? '✅' : '❌'}</li>
                        <li>test4: ${value4} ${value4 === true ? '✅' : '❌'}</li>
                        <li>test5: ${value5} ${value5 === null ? '✅' : '❌'}</li>
                    </ul>
                    <p><strong>存在检查：</strong></p>
                    <ul>
                        <li>has test1: ${hasTest1} ${hasTest1 ? '✅' : '❌'}</li>
                        <li>has test6: ${hasTest6} ${!hasTest6 ? '✅' : '❌'}</li>
                    </ul>
                    <p><strong>所有键：</strong> ${keys.join(', ')}</p>
                `;
                
                showResult('basic-result', result, 'success');
                showStatus('基本功能测试完成', 'success');
                
            } catch (error) {
                showResult('basic-result', `<h4>错误：</h4><pre>${error.message}</pre>`, 'error');
                showStatus('基本功能测试失败', 'error');
            }
        };

        // 事务功能测试
        window.testTransactionFunctions = function() {
            try {
                const db = new DocumentDB(document);
                
                // 设置初始数据
                db.set('initial', 'initial-value');
                
                // 开始事务
                const txId = db.beginTransaction();
                
                // 在事务中设置数据
                db.set('tx1', 'tx-value1');
                db.set('tx2', 'tx-value2');
                
                // 检查事务状态
                const status = db.getTransactionStatus();
                
                // 提交事务
                const commitResult = db.commitTransaction(txId);
                
                // 验证数据
                const value1 = db.get('tx1');
                const value2 = db.get('tx2');
                const initialValue = db.get('initial');
                
                const result = `
                    <h4>事务功能测试结果：</h4>
                    <p><strong>事务状态：</strong></p>
                    <ul>
                        <li>事务ID: ${txId}</li>
                        <li>提交结果: ${commitResult} ${commitResult ? '✅' : '❌'}</li>
                        <li>事务状态: ${JSON.stringify(status)}</li>
                    </ul>
                    <p><strong>数据验证：</strong></p>
                    <ul>
                        <li>tx1: ${value1} ${value1 === 'tx-value1' ? '✅' : '❌'}</li>
                        <li>tx2: ${value2} ${value2 === 'tx-value2' ? '✅' : '❌'}</li>
                        <li>initial: ${initialValue} ${initialValue === 'initial-value' ? '✅' : '❌'}</li>
                    </ul>
                `;
                
                showResult('transaction-result', result, 'success');
                showStatus('事务功能测试完成', 'success');
                
            } catch (error) {
                showResult('transaction-result', `<h4>错误：</h4><pre>${error.message}</pre>`, 'error');
                showStatus('事务功能测试失败', 'error');
            }
        };

        // 导出功能测试
        window.testExportFunctions = function() {
            try {
                const db = new DocumentDB(document);
                
                // 设置测试数据
                db.set('export1', 'export-value1');
                db.set('export2', { export: 'data' });
                
                // 导出数据库元素
                const exported = db.export();
                
                // 导出完整文档
                const exportedDoc = db.exportDocument({
                    title: 'Test Document',
                    charset: 'UTF-8',
                    pretty: true
                });
                
                const result = `
                    <h4>导出功能测试结果：</h4>
                    <p><strong>数据库元素导出：</strong></p>
                    <pre>${exported}</pre>
                    <p><strong>完整文档导出（前500字符）：</strong></p>
                    <pre>${exportedDoc.substring(0, 500)}...</pre>
                    <p><strong>导出验证：</strong></p>
                    <ul>
                        <li>包含数据库元素: ${exported.includes('id="document-db"') ? '✅' : '❌'}</li>
                        <li>包含数据: ${exported.includes('data-key="export1"') ? '✅' : '❌'}</li>
                        <li>完整文档包含DOCTYPE: ${exportedDoc.includes('<!DOCTYPE html>') ? '✅' : '❌'}</li>
                        <li>完整文档包含HTML标签: ${exportedDoc.includes('<html') ? '✅' : '❌'}</li>
                    </ul>
                `;
                
                showResult('export-result', result, 'success');
                showStatus('导出功能测试完成', 'success');
                
            } catch (error) {
                showResult('export-result', `<h4>错误：</h4><pre>${error.message}</pre>`, 'error');
                showStatus('导出功能测试失败', 'error');
            }
        };

        // 性能测试
        window.testPerformance = function() {
            try {
                const db = new DocumentDB(document);
                const startTime = performance.now();
                
                // 批量写入测试
                for (let i = 0; i < 1000; i++) {
                    db.set(`perf${i}`, `value${i}`);
                }
                
                const writeTime = performance.now() - startTime;
                
                // 批量读取测试
                const readStartTime = performance.now();
                for (let i = 0; i < 1000; i++) {
                    db.get(`perf${i}`);
                }
                const readTime = performance.now() - readStartTime;
                
                // 列出所有键
                const listStartTime = performance.now();
                const keys = db.list();
                const listTime = performance.now() - listStartTime;
                
                const result = `
                    <h4>性能测试结果：</h4>
                    <p><strong>性能指标：</strong></p>
                    <ul>
                        <li>写入1000个数据项: ${writeTime.toFixed(2)}ms</li>
                        <li>读取1000个数据项: ${readTime.toFixed(2)}ms</li>
                        <li>列出所有键: ${listTime.toFixed(2)}ms</li>
                        <li>总数据项数量: ${keys.length}</li>
                    </ul>
                    <p><strong>性能评估：</strong></p>
                    <ul>
                        <li>写入性能: ${writeTime < 1000 ? '✅ 优秀' : writeTime < 2000 ? '⚠️ 良好' : '❌ 需要优化'}</li>
                        <li>读取性能: ${readTime < 500 ? '✅ 优秀' : readTime < 1000 ? '⚠️ 良好' : '❌ 需要优化'}</li>
                        <li>列表性能: ${listTime < 100 ? '✅ 优秀' : listTime < 200 ? '⚠️ 良好' : '❌ 需要优化'}</li>
                    </ul>
                `;
                
                showResult('performance-result', result, 'success');
                showStatus('性能测试完成', 'success');
                
            } catch (error) {
                showResult('performance-result', `<h4>错误：</h4><pre>${error.message}</pre>`, 'error');
                showStatus('性能测试失败', 'error');
            }
        };

        // 运行所有测试
        window.runAllTests = function() {
            testBasicFunctions();
            setTimeout(() => testTransactionFunctions(), 1000);
            setTimeout(() => testExportFunctions(), 2000);
            setTimeout(() => testPerformance(), 3000);
            
            showStatus('开始运行所有测试', 'success');
        };
    </script>
</body>
</html> 